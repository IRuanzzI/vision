<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VisionGuard Pro - Vers√£o Industrial v2.1</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --bg-input: #334155;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --blue: #3b82f6;
            --blue-hover: #2563eb;
            --cyan: #0891b2;
            --green: #16a34a;
            --red: #dc2626;
            --amber: #d97706;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.5;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--bg-input);
            padding-bottom: 1rem;
        }

        .panel {
            background-color: var(--bg-panel);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid var(--bg-input);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .video-container {
            position: relative;
            background: #000;
            border-radius: 0.75rem;
            overflow: hidden;
            aspect-ratio: 4 / 3;
            border: 2px solid var(--bg-input);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #000;
        }

        .detection-zone {
            position: absolute;
            top: 20%;
            left: 20%;
            width: 60%;
            height: 60%;
            border: 2px dashed rgba(59, 130, 246, 0.5);
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .detection-zone::before {
            content: "√ÅREA DE INSPE√á√ÉO";
            font-size: 10px;
            color: var(--blue);
            background: rgba(15, 23, 42, 0.8);
            padding: 2px 5px;
            border-radius: 3px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .main-grid { grid-template-columns: 2fr 1fr; }
        }

        .btn {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            text-transform: uppercase;
            font-size: 0.75rem;
            text-align: center;
            display: inline-block;
        }

        .btn-blue { background-color: var(--blue); color: white; }
        .btn-cyan { background-color: var(--cyan); color: white; width: 100%; }
        .btn-green { background-color: var(--green); color: white; width: 100%; }
        .btn-amber { background-color: var(--amber); color: white; width: 100%; }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; }

        .alert-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-panel);
            padding: 2rem;
            border-radius: 1.5rem;
            max-width: 400px;
            text-align: center;
            border: 2px solid var(--blue);
        }

        .stat-card {
            background: rgba(15, 23, 42, 0.4);
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid var(--bg-input);
        }

        .gauge-container {
            width: 100%;
            background: var(--bg-input);
            height: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .gauge-bar {
            height: 100%;
            width: 0%;
            background: var(--blue);
            transition: width 0.1s linear;
        }

        #ref-preview {
            width: 100%;
            aspect-ratio: 4/3;
            border-radius: 0.5rem;
            border: 1px solid var(--bg-input);
            background: #000;
            object-fit: cover;
        }

        canvas { display: none; }
        .hidden { display: none !important; }
        
        .error-log {
            background: #450a0a;
            color: #fecaca;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.7rem;
            margin-top: 1rem;
            display: none;
        }

    </style>
</head>
<body>

    <div id="validation-modal" class="alert-modal">
        <div class="modal-content">
            <h2 style="color: var(--blue); margin-bottom: 1rem;">AUDITORIA DE PROCESSO</h2>
            <p style="font-size: 0.875rem; margin-bottom: 1.5rem;">
                O sistema atingiu <span id="modal-counter">100</span> pe√ßas. 
                <br><br>
                <b>Aten√ß√£o:</b> Verifique se a ilumina√ß√£o e o posicionamento da c√¢mera continuam corretos.
            </p>
            <button onclick="closeValidationModal()" class="btn btn-blue" style="width: 100%;">Confirmar e Continuar</button>
        </div>
    </div>

    <div class="container">
        <header>
            <div>
                <h1 style="color: var(--blue); font-size: 1.2rem;">VisionGuard Pro <span style="font-size: 0.7rem; opacity: 0.6;">v2.1</span></h1>
                <p style="font-size: 0.65rem; color: var(--text-muted);">M√≥dulo Mobile-Optimized de Preven√ß√£o de Mix</p>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="startCamera()" id="btn-start" class="btn btn-blue">Abrir C√¢mera</button>
                <button onclick="resetSystem()" class="btn" style="background: var(--bg-input); color: white;">Reset</button>
            </div>
        </header>

        <div id="camera-error" class="error-log"></div>

        <div class="main-grid">
            <div class="space-y" style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span id="status-badge" style="font-size: 0.7rem; font-weight: bold; color: var(--text-muted);">SISTEMA OFFLINE</span>
                        <div id="result-label" class="hidden" style="padding: 0.2rem 0.6rem; border-radius: 4px; font-weight: 900; font-size: 0.7rem;"></div>
                    </div>

                    <div class="video-container">
                        <video id="video" autoplay playsinline muted></video>
                        <div class="detection-zone"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-top: 1rem;">
                        <button onclick="captureReference()" id="btn-train" disabled class="btn btn-cyan">1. Gravar Padr√£o</button>
                        <button onclick="toggleInspection()" id="btn-inspect" disabled class="btn btn-green">2. Monitorar</button>
                    </div>
                </div>

                <div class="panel" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">
                    <div class="stat-card"><p style="font-size: 0.5rem; color: var(--text-muted);">TOTAL</p><p id="stat-total" style="font-size: 1rem; font-weight: 900;">0</p></div>
                    <div class="stat-card" style="color: var(--green);"><p style="font-size: 0.5rem; color: var(--text-muted);">OK</p><p id="stat-ok" style="font-size: 1rem; font-weight: 900;">0</p></div>
                    <div class="stat-card" style="color: var(--red);"><p style="font-size: 0.5rem; color: var(--text-muted);">FALHA</p><p id="stat-fail" style="font-size: 1rem; font-weight: 900;">0</p></div>
                    <div class="stat-card" style="color: var(--blue);"><p style="font-size: 0.5rem; color: var(--text-muted);">QUAL.</p><p id="stat-eff" style="font-size: 1rem; font-weight: 900;">100%</p></div>
                </div>
            </div>

            <div class="space-y" style="display: flex; flex-direction: column; gap: 1rem;">
                <div class="panel">
                    <h3 style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 0.5rem; text-transform: uppercase;">Refer√™ncia Capturada</h3>
                    <img id="ref-preview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 24 24' fill='none' stroke='%23334155' stroke-width='1' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect width='18' height='18' x='3' y='3' rx='2' ry='2'%3E%3C/rect%3E%3Cpath d='M3 9h18'%3E%3C/path%3E%3Cpath d='M9 21V9'%3E%3C/path%3E%3C/svg%3E">
                </div>

                <div class="panel">
                    <h3 style="font-size: 0.6rem; color: var(--text-muted); margin-bottom: 1rem; text-transform: uppercase;">An√°lise de Similaridade</h3>
                    
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.4rem;">
                            <span>Match:</span>
                            <strong id="sim-value" style="color: var(--blue);">0%</strong>
                        </div>
                        <div class="gauge-container">
                            <div id="sim-bar" class="gauge-bar"></div>
                        </div>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.75rem; margin-bottom: 0.4rem;">
                            <span>Toler√¢ncia:</span>
                            <strong id="threshold-val" style="color: var(--cyan);">85%</strong>
                        </div>
                        <input type="range" id="threshold" min="60" max="98" value="85" style="width: 100%;" oninput="updateThreshold(this.value)">
                    </div>

                    <button id="btn-manual-count" onclick="manualRecord()" class="btn hidden" style="background: white; color: black; width: 100%; padding: 1.2rem; font-size: 1rem;">VALIDAR PE√áA</button>
                </div>
            </div>
        </div>
    </div>

    <canvas id="ref-canvas" width="320" height="240"></canvas>
    <canvas id="proc-canvas" width="320" height="240"></canvas>

    <script>
        let isInspecting = false;
        let referenceCaptured = false;
        let threshold = 85;
        let total = 0;
        let fails = 0;
        let lastResult = 'NONE';
        let audioCtx = null;
        let stream = null;

        const video = document.getElementById('video');
        const procCanvas = document.getElementById('proc-canvas');
        const procCtx = procCanvas.getContext('2d', { willReadFrequently: true });
        const refCanvas = document.getElementById('ref-canvas');
        const refCtx = refCanvas.getContext('2d', { willReadFrequently: true });
        const errorLog = document.getElementById('camera-error');

        function playAlertSound() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
                oscillator.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + 0.3);
            } catch(e) { console.error("Audio error", e); }
        }

        async function startCamera() {
            errorLog.style.display = 'none';
            const constraints = {
                video: {
                    facingMode: 'environment', // C√¢mera traseira
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                },
                audio: false
            };

            try {
                // Tenta fechar streams antigos
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                
                // Garantia extra para dispositivos m√≥veis
                video.setAttribute('playsinline', '');
                video.setAttribute('muted', '');
                
                // Aguarda o v√≠deo carregar os metadados antes de tentar o play
                video.onloadedmetadata = () => {
                    video.play().catch(e => {
                        errorLog.innerText = "Erro ao dar play no v√≠deo: " + e.message;
                        errorLog.style.display = 'block';
                    });
                };

                document.getElementById('status-badge').innerText = "üü¢ C√ÇMERA ATIVA";
                document.getElementById('btn-train').disabled = false;
                document.getElementById('btn-start').innerText = "C√¢mera On";
                document.getElementById('btn-start').disabled = true;
                
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            } catch (err) {
                errorLog.innerText = "Erro de C√¢mera: " + err.name + " - " + err.message + ". Verifique se est√° usando HTTPS e se deu permiss√£o.";
                errorLog.style.display = 'block';
                console.error(err);
            }
        }

        function captureReference() {
            refCtx.drawImage(video, 0, 0, 320, 240);
            document.getElementById('ref-preview').src = refCanvas.toDataURL('image/png');
            document.getElementById('btn-inspect').disabled = false;
            referenceCaptured = true;
            document.getElementById('status-badge').innerText = "‚úÖ PADR√ÉO SALVO";
        }

        function toggleInspection() {
            isInspecting = !isInspecting;
            const btn = document.getElementById('btn-inspect');
            const btnManual = document.getElementById('btn-manual-count');
            
            if (isInspecting) {
                btn.innerText = "PARAR";
                btn.className = "btn btn-amber";
                btnManual.classList.remove('hidden');
                document.getElementById('status-badge').innerText = "üîç ANALISANDO...";
                requestAnimationFrame(runProcess);
            } else {
                btn.innerText = "INICIAR";
                btn.className = "btn btn-green";
                btnManual.classList.add('hidden');
                document.getElementById('result-label').classList.add('hidden');
                document.getElementById('status-badge').innerText = "PAUSADO";
            }
        }

        function runProcess() {
            if (!isInspecting) return;

            // Desenha quadro atual
            procCtx.drawImage(video, 0, 0, 320, 240);
            
            const currentData = procCtx.getImageData(0, 0, 320, 240).data;
            const refData = refCtx.getImageData(0, 0, 320, 240).data;

            let totalDiff = 0;
            // Compara√ß√£o de pixels simplificada para performance mobile
            for (let i = 0; i < currentData.length; i += 16) { // Pula alguns pixels para velocidade
                const diff = (Math.abs(currentData[i] - refData[i]) + 
                              Math.abs(currentData[i+1] - refData[i+1]) + 
                              Math.abs(currentData[i+2] - refData[i+2])) / 3;
                totalDiff += diff;
            }

            const pixelCount = (320 * 240) / 4;
            const avgDiff = totalDiff / pixelCount;
            const score = Math.round(Math.max(0, 100 - (avgDiff / 2)));
            
            updateUI(score);

            if (isInspecting) {
                setTimeout(() => requestAnimationFrame(runProcess), 100); // 10 FPS para n√£o travar o celular
            }
        }

        function updateUI(score) {
            const bar = document.getElementById('sim-bar');
            const val = document.getElementById('sim-value');
            const label = document.getElementById('result-label');
            
            val.innerText = score + "%";
            bar.style.width = score + "%";

            if (score >= threshold) {
                bar.style.backgroundColor = "var(--green)";
                label.innerText = "PE√áA OK";
                label.style.backgroundColor = "var(--green)";
                label.classList.remove('hidden');
                lastResult = 'OK';
            } else {
                bar.style.backgroundColor = "var(--red)";
                label.innerText = "MIX!";
                label.style.backgroundColor = "var(--red)";
                label.classList.remove('hidden');
                if (score < (threshold - 10)) playAlertSound();
                lastResult = 'FAIL';
            }
        }

        function manualRecord() {
            total++;
            if (lastResult === 'FAIL') fails++;
            
            document.getElementById('stat-total').innerText = total;
            document.getElementById('stat-ok').innerText = total - fails;
            document.getElementById('stat-fail').innerText = fails;
            
            const eff = total > 0 ? Math.round(((total - fails) / total) * 100) : 100;
            document.getElementById('stat-eff').innerText = eff + "%";

            if (total % 100 === 0) openValidationModal();
        }

        function openValidationModal() {
            isInspecting = false;
            document.getElementById('modal-counter').innerText = total;
            document.getElementById('validation-modal').style.display = "flex";
        }

        function closeValidationModal() {
            document.getElementById('validation-modal').style.display = "none";
            isInspecting = true;
            requestAnimationFrame(runProcess);
        }

        function updateThreshold(val) {
            threshold = val;
            document.getElementById('threshold-val').innerText = val + "%";
        }

        function resetSystem() {
            location.reload(); // Forma mais segura de limpar tudo em webapps de c√¢mera
        }
    </script>
</body>
</html>